<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Finder</title>
    {% load static %}
    <link href="https://fonts.googleapis.com/css2?family=Chewy&display=swap" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBc6vrJ5A4wgZ1llx01NgTwh7VsIdcvz3Q&libraries=places"></script>
    <link rel="stylesheet" href="{% static 'myappp/css/map.css' %}" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container {
            display: flex;
            height: 100%;
        }
        #sidebar {
            flex: 0 0 33%;
            max-width: 33%;
            padding: 20px;
            background-color: #4CB27CFF;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }
        .input-field {
            width: 80%;
            margin-bottom: 10px;
            padding: 8px;
            font-size: 14px;
        }
        #noResultsMessage {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .icon-container {
            display: flex;
            margin-left: 10px;
        }
        .icon-container img {
            margin-left: 10px;
            width: 30px;
            height: auto;
        }
        .overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #FF914CFF;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .overlay img {
            margin-right: 5px;
            width: 20px;
            height: auto;
        }
        .search-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .label {
            margin-bottom: 5px;
            color: #FF914CFF;
        }
        .search-button {
            background-color: #FF914CFF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            margin-top: 10px;
            width: 30%;
            font-family: 'Chewy', cursive;
        }
        .search-button:hover {
            background-color: rgba(255, 145, 76, 0.9);
        }
        #favoritesPanel {
            display: none;
            position: absolute;
            top: 80px;
            right: 20px;
            background-color: #4CB27CFF;
            color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 300px;
            z-index: 1000;
            overflow-y: auto;
            max-height: 300px;
        }
        .favorite-item {
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(255, 145, 76, 0.9);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
        }
        .remove-favorite {
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin-left: 10px;
        }
        .no-favorites {
            text-align: center;
            color: #ccc;
        }
        .add-favorite-button {
            background-color: #FF914CFF;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            font-family: 'Chewy', cursive;
        }
        .add-favorite-button:hover {
            background-color: rgba(255, 145, 76, 0.9);
        }
        .view-map-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            font-family: 'Chewy', cursive;
        }
        .view-map-button:hover {
            background-color: rgba(76, 175, 80, 0.9);
        }
        .button-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="sidebar">
            <div class="logo-container">
                <a href="#" onclick="refreshPage()">
                    <img src="{% static 'myappp/public/images/pizee.png' %}" alt="Pizee" class="logo" />
                </a>
                <a href="#" onclick="refreshPage()">
                    <img src="{% static 'myappp/public/images/fatlanta.png' %}" alt="Fatlanta" class="logo">
                </a>
                <div class="icon-container">
                    <a href="#" onclick="toggleFavorites()">
                        <img src="{% static 'myappp/public/images/profile_icon.png' %}" alt="Bookmark" class="icon">
                    </a>
                </div>
{#                <div class="icon-container">#}
{#                    <a href="{% url 'profile' %}">#}
{#                        <img src="{% static 'myappp/public/images/profile_icon.png' %}" alt="Profile" class="icon">#}
{#                    </a>#}
{#                </div>#}
            </div>
            <div class="overlay">
                <form action="{% url 'logout' %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" style="background: none; font-family: 'Chewy'; border: none; color: white; cursor: pointer;height:1px;width:60px;">
                        <img src="{% static 'myappp/public/images/img_log_out.svg' %}" alt="Log Out" class="icon">
                        Sign Out
                    </button>
                </form>
            </div>
            <div class="search-container">
                <label class="label" for="addressInput">Center Location:</label>
                <input id="addressInput" type="text" class="input-field" placeholder="Where is your starting location..." />

                <label class="label" for="cuisineInput">Cuisine:</label>
                <input id="cuisineInput" type="text" class="input-field" placeholder="Enter cuisine or restaurant name..." />

                <label class="label" for="radiusInput">Distance (optional):</label>
                <input id="radiusInput" type="number" class="input-field" placeholder="Enter radius in kilometers..." />

                <label class="label" for="ratingInput">Rating (0-5):</label>
                <input id="ratingInput" type="number" class="input-field" step="0.1" min="0" max="5" placeholder="Enter minimum rating..." />

                <button class="search-button" onclick="searchAddress()">Search</button>
                <span id="noResultsMessage"></span>
            </div>
        </div>
        <div id="map"></div>

        <!-- Dropdown Panel for Favorites -->
        <div id="favoritesPanel">
            <h1>{{ user.username }}'s Profile</h1>
                <div class="info">
                <label>Username: {{ user.username }}</label>
            </div>
            <div class="info">
                <label>Email: {{ user.email }}</label>
            </div>
            <div class="info">
                <label>Date Joined: {{ user.date_joined }}</label>
            </div>
            <h3>Your Favorite Restaurants</h3>
            <div id="favoritesList"></div>
            <h3>My Comments</h3>
        </div>
    </div>

    <script>
        var map, service, infowindow;
        var markers = [];
        var favorites = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: {lat: 33.7537, lng: -84.3863}
            });
            infowindow = new google.maps.InfoWindow();
            loadFavoritesMarkers(); // Load favorite markers on map initialization
        }

        function loadFavoritesMarkers() {
            favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            favorites.forEach(function(favorite) {
                var request = {
                    placeId: favorite.place_id
                };

                service = new google.maps.places.PlacesService(map);
                service.getDetails(request, function(details, status) {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        createFavoriteMarker(details);
                    }
                });
            });
        }

        function searchAddress() {
            var address = document.getElementById('addressInput').value;
            var cuisine = document.getElementById('cuisineInput').value;
            var radius = document.getElementById('radiusInput').value * 1000 || 24140; // Default to 15 miles if empty
            var rating = parseFloat(document.getElementById('ratingInput').value) || 0; // Default to 0 if empty
            var geocoder = new google.maps.Geocoder();

            geocoder.geocode({'address': address}, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    clearMarkers();
                    var location = results[0].geometry.location;
                    map.setCenter(location);
                    map.setZoom(15);
                    searchNearbyPlaces(location, cuisine, radius, rating);
                } else {
                    document.getElementById('noResultsMessage').innerText = 'Geocode was not successful for the following reason: ' + status;
                }
            });
        }

        function searchNearbyPlaces(location, cuisine, radius, minRating) {
            var request = {
                location: location,
                radius: radius,
                keyword: cuisine,
                type: ['restaurant']
            };

            service = new google.maps.places.PlacesService(map);
            service.nearbySearch(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    let found = false;
                    let notFavorite = true;
                    for (var i = 0; i < results.length; i++) {
                        if (results[i].rating >= minRating) {
                            createMarker(results[i]);
                            found = true;
                        }
                    }
                    loadFavoritesMarkers();
                    document.getElementById('noResultsMessage').innerText = found ? '' : 'No places match the requirements.';
                } else {
                    document.getElementById('noResultsMessage').innerText = 'Error retrieving places.';
                }
            });
        }

        function createFavoriteMarker(place) {
            var placeLoc = place.geometry.location;
            var marker = new google.maps.Marker({
                map: map,
                position: placeLoc,
                icon: "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png"
            });

            markers.push(marker);

            // Fetch detailed information about the place
            service.getDetails({ placeId: place.place_id }, function(details, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    google.maps.event.addListener(marker, 'click', function() {
                        var contentString = `
                            <h3>${details.name}</h3>
                            <p>${details.formatted_address}</p>
                            <p>${details.formatted_phone_number || ''}</p>
                            <p>Rating: ${details.rating || 'N/A'} (${details.user_ratings_total || 0} ratings)</p>
                            <p>${details.price_level ? '$'.repeat(details.price_level) : 'Price level not available'}</p>
                            <p>${details.opening_hours ? 'Open now' : 'Closed'}</p>
                            ${details.website ? `<p><a href="${details.website}" target="_blank">Website</a></p>` : ''}
                            <p><button class="add-favorite-button" onclick="addToFavorites('${details.name}', '${details.place_id}', '${details.formatted_address}', ${details.rating})">Add to Favorites</button></p>
                            ${details.photos ? `<img src="${details.photos[0].getUrl({ maxWidth: 200 })}" alt="${details.name} photo" style="width: 100%; max-width: 200px;">` : ''}
                            <h4>Reviews:</h4>
                            <div style="max-height: 100px; overflow-y: auto;">
                                ${details.reviews ? details.reviews.map(review => `
                                    <div>
                                        <strong>${review.author_name}</strong>: ${review.text}
                                        <p>Rating: ${review.rating}</p>
                                    </div>
                                `).join('') : '<p>No reviews available.</p>'}
                            </div>
                        `;
                        infowindow.setContent(contentString);
                        infowindow.open(map, this);
                    });
                }
            });
        }

        function createMarker(place) {
            var placeLoc = place.geometry.location;
            var marker = new google.maps.Marker({
                map: map,
                position: placeLoc,
            });

            markers.push(marker);

            // Fetch detailed information about the place
            service.getDetails({ placeId: place.place_id }, function(details, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    google.maps.event.addListener(marker, 'click', function() {
                        var contentString = `
                            <h3>${details.name}</h3>
                            <p>${details.formatted_address}</p>
                            <p>${details.formatted_phone_number || ''}</p>
                            <p>Rating: ${details.rating || 'N/A'} (${details.user_ratings_total || 0} ratings)</p>
                            <p>${details.price_level ? '$'.repeat(details.price_level) : 'Price level not available'}</p>
                            <p>${details.opening_hours ? 'Open now' : 'Closed'}</p>
                            ${details.website ? `<p><a href="${details.website}" target="_blank">Website</a></p>` : ''}
                            <p><button class="add-favorite-button" onclick="addToFavorites('${details.name}', '${details.place_id}', '${details.formatted_address}', ${details.rating})">Add to Favorites</button></p>
                            ${details.photos ? `<img src="${details.photos[0].getUrl({ maxWidth: 200 })}" alt="${details.name} photo" style="width: 100%; max-width: 200px;">` : ''}
                            <h4>Reviews:</h4>
                            <div style="max-height: 100px; overflow-y: auto;">
                                ${details.reviews ? details.reviews.map(review => `
                                    <div>
                                        <strong>${review.author_name}</strong>: ${review.text}
                                        <p>Rating: ${review.rating}</p>
                                    </div>
                                `).join('') : '<p>No reviews available.</p>'}
                            </div>
                        `;
                        infowindow.setContent(contentString);
                        infowindow.open(map, this);
                    });
                }
            });
        }


        function clearMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
            document.getElementById('noResultsMessage').innerText = '';
        }

        function addToFavorites(name, place_id, address, rating) {
            const favorite = { name, place_id, vicinity: address, rating };
            favorites = JSON.parse(localStorage.getItem('favorites')) || [];

            if (!favorites.some(fav => fav.place_id === place_id)) {
                favorites.push(favorite);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                alert(`${name} has been added to your favorites!`);
                loadFavorites(); // Refresh the favorites panel
                loadFavoritesMarkers();
            } else {
                alert(`${name} is already in your favorites.`);
            }
        }

        function toggleFavorites() {
            var panel = document.getElementById('favoritesPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                loadFavorites(); // Load favorites when opening the panel
            } else {
                panel.style.display = 'none';
            }
        }

        function loadFavorites() {
            var favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            var listDiv = document.getElementById('favoritesList');
            listDiv.innerHTML = ''; // Clear previous content

            if (favorites.length === 0) {
                listDiv.innerHTML = '<p class="no-favorites">No favorites added yet!</p>';
                return;
            }

            favorites.forEach(function(place) {
                var item = document.createElement('div');
                item.className = 'favorite-item';
                item.innerHTML = `
                    <strong>${place.name}</strong><br>
                    ${place.vicinity || 'Address not available'}<br>
                    Rating: ${place.rating || 'N/A'}
                    <div class="button-container">
                        <button class="view-map-button" onclick="viewOnMap('${place.place_id}')">View on Map</button>
                        <span class="remove-favorite" onclick="removeFavorite('${place.place_id}')"> X </span>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }

        function viewOnMap(place_id) {
            const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            const place = favorites.find(fav => fav.place_id === place_id);

            if (place) {
                const request = {
                    placeId: place.place_id
                };

                service = new google.maps.places.PlacesService(map);
                service.getDetails(request, function(details, status) {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        const location = details.geometry.location;
                        map.setCenter(location);
                        map.setZoom(15); // Adjust zoom level if necessary

                        // Create a marker for the selected favorite
                        createMarker(details);
                    }
                });
            }
        }

        function removeFavorite(place_id) {
            favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            favorites = favorites.filter(fav => fav.place_id !== place_id);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            clearMarkers();
            loadFavoritesMarkers();
            loadFavorites(); // Refresh the favorites list
            alert('Favorite removed!');
        }

        window.onload = function() {
            favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            initMap();
        };

        function refreshPage() {
            location.reload();
        }
    </script>
</body>
</html>


